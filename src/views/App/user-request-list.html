<!DOCTYPE html>
<html lang="en">

<head>
    <%-head%>
</head>

<body>

    <%-nav%>

    <div class="mx-5">

        <div class="mt-5">
          <table class="table1">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Employee number</th>
                <th scope="col">Actions</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody>
              
              <% requestList.forEach((item, index)=>{%>
                <tr>
                  <td><%=item.name%></td>
                  <td><%=item.employee_number%></td>
                  <td>
                    <div class="dropdown dropend">
                      <button class="btn btn-sm p-0" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="/assets/images/icons/Group 482180.svg" alt="dropdown" width="25" height="25">
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item accept-button" data-id="<%=item.id%>" type="button" data-bs-toggle="modal" data-bs-target="#employee_request_modal">Accept</a></li>
                        <li><a class="dropdown-item reject-button" data-id="<%=item.id%>">Reject</a></li>
                        <li class="delete-button" data-id="<%=item.id%>"><a class="dropdown-item" href="#" >Delete</a></li>
                      </ul>
                    </div>
                  </td>
                  </td>
                  <td>
                    <span class="badge rounded-pill bg-<%=item.status == 1 ? 'primary' : item.status == 2 ? 'success' : 'danger'%>"><%=item.status == 1 ? 'Pending' : item.status == 2 ? 'Accepted' : 'Rejected'%></span>                    
                  </td>
                </tr>
              <%})%>
        
               
            </tbody>
          </table>
        </div>

        <div class="modal fade" id="employee_request_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Employee details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="form-group w-100 mb-2">
                  <label class="form-label mb-1" for="">Email</label>
                  <input type="text" class="form-control w-full" id="email">
                </div>
                <div class="form-group w-100 mb-2">
                  <label class="form-label mb-1" for="">Mobile</label>
                  <input type="text" class="form-control w-full" id="mobile">
                </div>
                <div class="form-group w-100 mb-2">
                  <label class="form-label mb-1" for="">Password</label>
                  <input type="password" class="form-control w-full" id="password">
                </div>
                <div class="form-group w-100 mb-2">
                  <label class="form-label mb-1" for="departmentSelect">Select Department</label>
                  <select class="form-control w-full" id="departmentSelect" onchange="fetchDesignations()">
                      <option value="">Select a department</option>
                      <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="form-group w-100 mb-2">
                  <label class="form-label mb-1" for="designationSelect">Select Designation</label>
                  <select class="form-control w-full" id="designationSelect">
                    <option value="">Select a designation</option>
                      <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="form-group w-100 mb-2">
                    <label class="form-label mb-1" for="approveLevel">Select Approval Level</label>
                    <select class="form-control w-full" id="approveLevel" >
                      <option value="1">No Approval</option>
                      <option value="2">Approval Level 1</option>
                      <option value="3">Approval Level 2</option>
                    </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="accept-button">Accept</button>
              </div>
            </div>
          </div>
        </div>


        <%-script%>
        <script>
          var requestId;
          $(document).ready(function(){
            $('.delete-button').click(function(e){
              e.preventDefault();
              var id = $(this).data('id');
              deleteData(id);
            });
            $('.reject-button').click(function(e){
              e.preventDefault();
              var id = $(this).data('id');
              rejectData(id);
            });

            $('.accept-button').click(function(e){
              e.preventDefault();
              requestId = $(this).data('id');
              console.log("ðŸš€ ~ $ ~ requestId:", requestId)
            });

            $('#accept-button').click(acceptData);

          });
          function acceptData(){
            console.log('Accepting data...', requestId);
            $.ajax({
              url: '/api/v1/user_register_request/accept',
              type: 'POST',
              data: {
                "id": requestId,
                "email": $('#email').val(),
                "mobile": $('#mobile').val(),
                "password": $('#password').val(),
                "department": $("#departmentSelect").val(), 
                "designation": $("#designationSelect").val(),
                "approveLevel": $("#approveLevel").val() 
              },
              success: function(response){
                if(response.status){
                  location.reload();
                }else{
                  showAlert({
                    message:"ERROR: "+response.message,
                    closeText:'ok',
                  });
                }
              },
              error: function(err){
                console.log(err);
              }
            });
          }
          
          function deleteData(id){
            showAlert({
                message:"Are you sure you want to delete this request?",
                closeText:'no',
                acceptText:'yes',
                acceptFunction: ()=>{
                  $.ajax({
                    url: '/api/v1/user_register_request/delete',
                    type: 'POST',
                    data: {id:id},
                    success: function(response){
                      if(response.status){
                        location.reload();
                      }else{
                        showAlert({
                          message:"ERROR: "+response.message,
                          closeText:'ok',
                        });
                          console.log("ðŸš€ ~ deleteClient ~ response:", response)
                      }
                    },
                    error: function(err){
                      console.log(err);
                    }
                  });
                },
            });
          }
          
          function rejectData(id){
            showAlert({
                message:"Are you sure you want to reject this request?",
                closeText:'no',
                acceptText:'yes',
                acceptFunction: ()=>{
                  $.ajax({
                    url: '/api/v1/user_register_request/reject',
                    type: 'POST',
                    data: {id:id},
                    success: function(response){
                      if(response.status){
                        location.reload();
                      }else{
                        showAlert({
                          message:"ERROR: "+response.message,
                          closeText:'ok',
                        });
                          console.log("ðŸš€ ~ deleteClient ~ response:", response)
                      }
                    },
                    error: function(err){
                      console.log(err);
                    }
                  });
                },
            });
          }
          

          $(document).ready(function() {
                $.ajax({
                    url: '/api/v1/department/list', 
                    type: 'GET',
                    success: function(response) {
                        if (response.status) {
                            response.data.forEach(department => {
                                $('#departmentSelect').append(`<option value="${department.id}">${department.department_name}</option>`);
                            });
                        } else {
                            console.error("Error fetching departments: " + response.message);
                        }
                    },
                    error: function(error) {
                        console.error("Error: ", error);
                    }
                });
            });

            // Fetch designations based on the selected department
            function fetchDesignations() {
                const departmentId = $('#departmentSelect').val();
                $('#designationSelect').empty().append('<option value="">Select a designation</option>'); 
                
                if (departmentId) {
                    $.ajax({
                        url: `/api/v1/department_designation/view`, 
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "id":  departmentId
                        }),
                        success: function(response) {
                            if (response.status) {
                                response.data.forEach(designation => {
                                    $('#designationSelect').append(`<option value="${designation.id}">${designation.designation}</option>`);
                                });
                            } else {
                                console.error("Error fetching designations: " + response.message);
                            }
                        },
                        error: function(error) {
                            console.error("Error: ", error);
                        }
                    });
                }
            }
       </script>
       
</body>

</div>

</html>